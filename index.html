<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeScapeï¼šæœªä¾†ç¨‹å¸‚</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Jersey+15&family=Oxanium:wght@200..800&family=Reddit+Sans:ital,wght@0,200..900;1,200..900&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/theme/dracula.min.css">

    <style>
        /* â•â• Reset & Base â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        html,
        body {
            height: 100%;
            overflow: hidden;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Oxanium', sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1a3e 50%, #0d1b2a 100%);
            color: #00ff88;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* â•â• Header â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .header {
            font-family: 'Jersey 15', sans-serif;
            background: rgba(0, 255, 136, 0.1);
            border-bottom: 2px solid #00ff88;
            padding: 0.55rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1.2rem;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 2.5rem;
            text-shadow: 0 0 10px #00ff88, 0 0 20px #ff006e;
            letter-spacing: 3px;
            color: #00ffff;
        }

        .header-sub {
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .header-sub .subtitle {
            font-family: 'Oxanium', sans-serif;
            font-size: 0.68rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            color: rgba(0, 255, 136, 0.45);
        }

        #mapClock {
            margin-left: auto;
            font-family: 'Jersey 15', monospace;
            font-size: 1.5rem;
            padding: 3px 16px;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            background: rgba(0, 0, 0, 0.35);
            letter-spacing: 2px;
            transition: color 0.5s, border-color 0.5s, text-shadow 0.5s;
        }

        #mapClock.day {
            color: #f5d060;
            border-color: rgba(245, 208, 96, 0.4);
            text-shadow: 0 0 12px #f5d060;
        }

        #mapClock.night {
            color: #8899cc;
            border-color: rgba(136, 153, 204, 0.4);
            text-shadow: 0 0 12px #8899cc;
        }

        /* â•â• Layout â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .container {
            display: flex;
            flex: 1;
            gap: 1rem;
            padding: 1rem;
            overflow: hidden;
        }

        /* â•â• Left Panel (Editor) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .left-content {
            flex: 0 0 420px;
            min-width: 290px;
            max-width: 520px;
            display: flex;
            flex-direction: column;
            background: rgba(0, 255, 136, 0.04);
            border: 1px solid #00ff88;
            border-radius: 8px;
            box-shadow: inset 0 0 20px rgba(0, 255, 136, 0.07), 0 0 18px rgba(0, 255, 136, 0.1);
            overflow: hidden;
        }

        /* Editor top bar */
        .editor-header {
            display: flex;
            align-items: center;
            padding: 7px 12px;
            background: rgba(0, 255, 136, 0.08);
            border-bottom: 1px solid rgba(0, 255, 136, 0.22);
            gap: 8px;
            flex-shrink: 0;
        }

        .lang-badge {
            font-family: 'Oxanium', monospace;
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(55, 118, 171, 0.18);
            color: #4ea8d4;
            border: 1px solid rgba(55, 118, 171, 0.45);
        }

        .lang-badge.js-badge {
            background: rgba(0, 255, 136, 0.1);
            color: #4af080;
            border-color: rgba(74, 240, 128, 0.4);
        }

        .file-name {
            font-family: 'Oxanium', monospace;
            font-size: 11px;
            color: rgba(0, 255, 136, 0.4);
        }

        /* CodeMirror */
        .cm-wrap {
            flex: 1;
            min-height: 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .CodeMirror {
            height: 100% !important;
            font-family: 'Oxanium', 'Courier New', monospace;
            font-size: 12.5px;
            line-height: 1.75;
            background: #08080f !important;
        }

        .CodeMirror-gutters {
            background: #06060c !important;
            border-right: 1px solid rgba(0, 255, 136, 0.12) !important;
        }

        .CodeMirror-linenumber {
            color: rgba(0, 255, 136, 0.22) !important;
        }

        .CodeMirror-cursor {
            border-left: 2px solid #00ff88 !important;
        }

        .CodeMirror-selected {
            background: rgba(0, 255, 136, 0.1) !important;
        }

        /* JS preview pane */
        .js-preview {
            display: none;
            flex-direction: column;
            flex: 0 0 170px;
            border-top: 1px solid rgba(0, 255, 136, 0.18);
        }

        .js-preview.visible {
            display: flex;
        }

        .js-preview-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 12px;
            background: rgba(0, 255, 136, 0.05);
            border-bottom: 1px solid rgba(0, 255, 136, 0.15);
            flex-shrink: 0;
        }

        .js-preview-header .label {
            font-size: 10px;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(74, 240, 128, 0.5);
        }

        .js-code {
            flex: 1;
            overflow-y: auto;
            padding: 7px 12px;
            font-family: 'Oxanium', monospace;
            font-size: 10.5px;
            line-height: 1.8;
            color: #3add7a;
            white-space: pre;
            background: #050810;
        }

        .js-code::-webkit-scrollbar {
            width: 3px;
        }

        .js-code::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
        }

        /* Run bar */
        .run-bar {
            display: flex;
            align-items: center;
            padding: 7px 10px;
            gap: 6px;
            background: rgba(0, 255, 136, 0.06);
            border-top: 1px solid rgba(0, 255, 136, 0.2);
            flex-shrink: 0;
        }

        .btn {
            font-family: 'Oxanium', monospace;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            padding: 6px 14px;
            transition: all 0.14s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-run {
            background: #00ff88;
            color: #040e12;
            box-shadow: 0 0 12px rgba(0, 255, 136, 0.4);
        }

        .btn-run:hover {
            background: #33ffaa;
            box-shadow: 0 0 24px rgba(0, 255, 136, 0.65);
            transform: translateY(-1px);
        }

        .btn-run:active {
            transform: translateY(0);
        }

        .btn-run.running {
            animation: pulse-neon 0.5s ease infinite alternate;
        }

        @keyframes pulse-neon {
            from {
                box-shadow: 0 0 8px rgba(0, 255, 136, 0.4);
            }

            to {
                box-shadow: 0 0 30px rgba(0, 255, 136, 0.95), 0 0 60px rgba(0, 255, 136, 0.3);
            }
        }

        .btn-clear {
            background: transparent;
            color: #ff006e;
            border: 1px solid #ff006e;
        }

        .btn-clear:hover {
            background: rgba(255, 0, 110, 0.12);
            box-shadow: 0 0 14px rgba(255, 0, 110, 0.3);
        }

        .btn-js {
            background: transparent;
            color: #4af080;
            border: 1px solid rgba(74, 240, 128, 0.45);
        }

        .btn-js:hover {
            background: rgba(74, 240, 128, 0.08);
        }

        .run-hint {
            margin-left: auto;
            font-size: 9.5px;
            color: rgba(0, 255, 136, 0.25);
            letter-spacing: 0.5px;
        }

        /* Output log */
        .output-panel {
            border-top: 1px solid rgba(0, 255, 136, 0.18);
            flex-shrink: 0;
            overflow: hidden;
            transition: max-height 0.25s ease;
            background: rgba(0, 0, 0, 0.28);
        }

        .output-panel.expanded {
            max-height: 155px;
        }

        .output-panel.collapsed {
            max-height: 0;
        }

        .output-header {
            display: flex;
            align-items: center;
            padding: 5px 12px;
            background: rgba(0, 255, 136, 0.07);
            border-bottom: 1px solid rgba(0, 255, 136, 0.12);
            cursor: pointer;
            user-select: none;
            gap: 8px;
        }

        .output-header .label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(0, 255, 136, 0.45);
        }

        .badge {
            font-family: 'Oxanium', monospace;
            font-size: 10px;
            padding: 1px 7px;
            border-radius: 3px;
            margin-left: auto;
        }

        .badge-ok {
            background: rgba(0, 255, 136, 0.1);
            color: #00ff88;
            border: 1px solid rgba(0, 255, 136, 0.3);
        }

        .badge-err {
            background: rgba(255, 0, 110, 0.1);
            color: #ff006e;
            border: 1px solid rgba(255, 0, 110, 0.3);
        }

        .badge-info {
            background: rgba(0, 200, 255, 0.1);
            color: #00c8ff;
            border: 1px solid rgba(0, 200, 255, 0.3);
        }

        .output-body {
            max-height: 118px;
            overflow-y: auto;
            padding: 5px 12px;
            font-family: 'Oxanium', monospace;
            font-size: 11px;
            line-height: 1.9;
        }

        .output-body::-webkit-scrollbar {
            width: 3px;
        }

        .output-body::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
        }

        .log-ok {
            color: #00ff88;
        }

        .log-err {
            color: #ff006e;
        }

        .log-info {
            color: #00c8ff;
        }

        .log-warn {
            color: #f5a623;
        }

        /* Library panel */
        .lib-panel {
            border-top: 1px solid rgba(0, 255, 136, 0.18);
            flex-shrink: 0;
            background: rgba(0, 255, 136, 0.02);
        }

        .lib-header {
            display: flex;
            align-items: center;
            padding: 5px 12px;
            background: rgba(0, 255, 136, 0.07);
            cursor: pointer;
            user-select: none;
            gap: 7px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.12);
        }

        .lib-header .label {
            font-size: 10px;
            font-weight: 700;
            letter-spacing: 1px;
            text-transform: uppercase;
            color: rgba(255, 200, 0, 0.65);
        }

        .lib-header .toggle-icon {
            margin-left: auto;
            color: rgba(0, 255, 136, 0.35);
            font-size: 9px;
        }

        .lib-body {
            padding: 6px;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            max-height: 120px;
            overflow-y: auto;
        }

        .lib-body::-webkit-scrollbar {
            width: 3px;
        }

        .lib-body::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 136, 0.3);
        }

        .lib-fn-card {
            background: rgba(0, 255, 136, 0.04);
            border: 1px solid rgba(0, 255, 136, 0.18);
            border-radius: 5px;
            padding: 4px 9px;
            cursor: pointer;
            transition: all 0.13s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .lib-fn-card:hover {
            border-color: #f5a623;
            background: rgba(245, 166, 35, 0.08);
            box-shadow: 0 0 10px rgba(245, 166, 35, 0.2);
            transform: translateY(-1px);
        }

        .lib-fn-card .fn-emoji {
            font-size: 14px;
        }

        .lib-fn-card .fn-name {
            font-family: 'Oxanium', monospace;
            font-size: 11px;
            font-weight: 700;
            color: #f5a623;
        }

        /* â•â• Right Panel (Map) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .right-content {
            flex: 1 1 0;
            min-width: 0;
            background: rgba(255, 0, 110, 0.05);
            border: 1px solid #ff006e;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 0 30px rgba(255, 0, 110, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #mapContainer {
            flex: 1 1 0;
            width: 100%;
            min-height: 0;
            position: relative;
            overflow: hidden;
            border-radius: 4px;
        }

        #mapContainer canvas {
            display: block;
            width: 100% !important;
            height: 100% !important;
        }

        /* Reset button (kept from original style.css) */
        #mapResetBtn {
            position: absolute;
            top: 12px;
            right: 12px;
            z-index: 10;
            background: rgba(10, 14, 39, 0.85);
            color: #00ff88;
            border: 1px solid #00ff88;
            border-radius: 6px;
            padding: 6px 14px;
            font-family: 'Oxanium', sans-serif;
            font-size: 0.78rem;
            letter-spacing: 1px;
            cursor: pointer;
            backdrop-filter: blur(4px);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
            transition: background 0.15s, box-shadow 0.15s, color 0.15s;
            user-select: none;
        }

        #mapResetBtn:hover {
            background: rgba(0, 255, 136, 0.15);
            box-shadow: 0 0 18px rgba(0, 255, 136, 0.45);
        }

        #mapResetBtn.active,
        #mapResetBtn:active {
            background: rgba(0, 255, 136, 0.3);
            color: #ffffff;
            box-shadow: 0 0 24px rgba(0, 255, 136, 0.7);
        }

        /* Map hints (kept from original style.css) */
        #mapHints {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10;
            display: flex;
            gap: 16px;
            background: rgba(10, 14, 39, 0.75);
            border: 1px solid rgba(0, 255, 136, 0.25);
            border-radius: 6px;
            padding: 5px 14px;
            backdrop-filter: blur(4px);
            pointer-events: none;
            opacity: 0.7;
            transition: opacity 0.3s;
        }

        #mapContainer:hover #mapHints {
            opacity: 1;
        }

        #mapHints span {
            font-family: 'Oxanium', sans-serif;
            font-size: 0.7rem;
            color: #00ff88;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        /* â•â• Footer â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .footer {
            background: rgba(0, 255, 136, 0.1);
            border-top: 2px solid #00ff88;
            display: flex;
            align-items: center;
            padding: 0.4rem 1.5rem;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
            flex-shrink: 0;
            gap: 12px;
        }

        .footer p {
            font-size: 0.7rem;
            color: rgba(0, 255, 136, 0.45);
            letter-spacing: 0.5px;
        }

        #footerStatus {
            margin-left: auto;
            font-size: 0.7rem;
            letter-spacing: 0.5px;
            transition: color 0.3s, text-shadow 0.3s;
        }

        #footerStatus.ready {
            color: #00ff88;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }

        #footerStatus.running {
            color: #f5a623;
            text-shadow: 0 0 8px rgba(245, 166, 35, 0.5);
        }

        #footerStatus.error {
            color: #ff006e;
            text-shadow: 0 0 8px rgba(255, 0, 110, 0.5);
        }

        /* â•â• Scrollbars (from original style.css) â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0a0e27;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff88;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #ff006e;
        }

        /* â•â• Tooltip â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .fn-tooltip {
            position: fixed;
            z-index: 300;
            background: #0a0e27;
            border: 1px solid rgba(0, 255, 136, 0.35);
            border-radius: 7px;
            padding: 10px 14px;
            max-width: 270px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.75), 0 0 20px rgba(0, 255, 136, 0.12);
            font-size: 11.5px;
            line-height: 1.65;
            display: none;
            pointer-events: none;
        }

        .fn-tooltip .tt-name {
            font-weight: 700;
            color: #f5a623;
            margin-bottom: 3px;
            font-size: 12.5px;
        }

        .fn-tooltip .tt-sig {
            font-family: 'Oxanium', monospace;
            font-size: 10.5px;
            color: #4ea8d4;
            margin-bottom: 5px;
        }

        .fn-tooltip .tt-desc {
            color: rgba(0, 255, 136, 0.8);
            margin-bottom: 4px;
        }

        .fn-tooltip .tt-param {
            font-size: 10.5px;
            color: rgba(0, 255, 136, 0.4);
        }

        .fn-tooltip .tt-param span {
            color: #00ff88;
        }

        .fn-tooltip .tt-hint {
            margin-top: 6px;
            font-size: 10px;
            color: rgba(245, 166, 35, 0.55);
        }
    </style>
</head>

<body>

    <!-- â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <header class="header">
        <h1>CITY CODER</h1>
        <div class="header-sub">
            <span class="subtitle">CodeScapeï¼šæœªä¾†ç¨‹å¸‚</span>
        </div>
        <div id="mapClock" class="night">00:00</div>
    </header>

    <!-- â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="container">

        <!-- Left: Python Editor -->
        <aside class="left-content">

            <div class="editor-header">
                <span class="lang-badge">Python</span>
                <span class="file-name">city_builder.py</span>
            </div>

            <div class="cm-wrap" id="editorWrap"></div>

            <!-- JS Preview -->
            <div class="js-preview" id="jsPreview">
                <div class="js-preview-header">
                    <span class="lang-badge js-badge">JS</span>
                    <span class="label">è½‰æ›å¾Œçš„ JavaScript</span>
                </div>
                <div class="js-code" id="jsCode"></div>
            </div>

            <!-- Run bar -->
            <div class="run-bar">
                <button class="btn btn-run" id="btnRun">â–¶ åŸ·è¡Œ</button>
                <button class="btn btn-clear" id="btnClear">âœ• æ¸…é™¤åœ°åœ–</button>
                <button class="btn btn-js" id="btnJsToggle">{ } JS</button>
                <span class="run-hint">Ctrl+Enter</span>
            </div>

            <!-- Output -->
            <div class="output-panel expanded" id="outputPanel">
                <div class="output-header" id="outputHeader">
                    <span class="label">è¼¸å‡ºç´€éŒ„</span>
                    <span class="badge badge-info" id="outputBadge">å°±ç·’</span>
                </div>
                <div class="output-body" id="outputBody">
                    <span class="log-info">â–¸ æ­¡è¿ä¾†åˆ° CodeScapeï¼æ’°å¯« Python å¾ŒæŒ‰ â–¶ åŸ·è¡Œï¼Œå³å¯åœ¨å³å´åœ°åœ–å»ºé€ åŸå¸‚ã€‚</span>
                </div>
            </div>

            <!-- Library -->
            <div class="lib-panel">
                <div class="lib-header" id="libHeader">
                    <span>ğŸ“š</span>
                    <span class="label">å‡½å¼åº«</span>
                    <span class="toggle-icon" id="libToggleIcon">â–²</span>
                </div>
                <div class="lib-body" id="libBody"></div>
            </div>

        </aside>

        <!-- Right: 3D Map -->
        <main class="right-content">
            <div id="mapContainer">
                <button id="mapResetBtn" title="Reset view">âŒ‚ Reset</button>
                <div id="mapHints">
                    <span>ğŸ–± å·¦éµæ‹–æ›³ï¼šå¹³ç§»</span>
                    <span>ğŸ–± å³éµæ‹–æ›³ï¼šæ—‹è½‰</span>
                    <span>ğŸ–± æ»¾è¼ªï¼šç¸®æ”¾</span>
                </div>
            </div>
        </main>

    </div>

    <!-- â•â• FOOTER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <footer class="footer">
        <p>&copy; 2026 CodeScapeï¼šæœªä¾†ç¨‹å¸‚ Â· City Coder</p>
        <span id="footerStatus" class="ready">â— å°±ç·’</span>
    </footer>

    <!-- Tooltip -->
    <div class="fn-tooltip" id="fnTooltip"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.16/mode/python/python.min.js"></script>
    <script src="map-script.js"></script>
    <script src="city_library.js"></script>
    <script src="python-runner.js"></script>

    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        //  UI Logic
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        const STARTER_CODE =
            `# CodeScapeï¼šæœªä¾†ç¨‹å¸‚ ğŸ™ï¸
# æ’°å¯« Pythonï¼ŒæŒ‰ â–¶ åŸ·è¡Œï¼Œå³å¯åœ¨å³å´åœ°åœ–å»ºé€ åŸå¸‚ï¼
# é»æ“Šä¸‹æ–¹å‡½å¼åº«çš„å¡ç‰‡å¯ä»¥æ’å…¥ç¨‹å¼ç¢¼ç¯„ä¾‹

# å»ºé€ å¹¾æ£Ÿæˆ¿å­
build_house(name="å°æ˜çš„å®¶")
build_house(name="å°è¯çš„å®¶")
build_house(name="å°ç²çš„å®¶")

# è“‹ä¸€æ‰€å­¸æ ¡èˆ‡å…¬å…±è¨­æ–½
build_school(name="æœªä¾†ä¸­å­¸")
build_park(name="ä¸­å¤®å…¬åœ’")
build_library(name="å¸‚ç«‹åœ–æ›¸é¤¨")
build_pool(name="ç¤¾å€æ¸¸æ³³æ± ")

# å»ºé€ å•†æ¥­å€
build_shop(name="è¶…å¸‚")
build_shop(name="å’–å•¡å»³")

# å»£å ´èˆ‡åŸºç¤å»ºè¨­
build_fountain(name="å»£å ´å™´æ°´æ± ")
build_power_tower()
build_hospital(name="å¸‚ç«‹é†«é™¢")
`;

        const LIB_FUNCTIONS = [
            { name: 'build_house', emoji: 'ğŸ ', desc: 'è“‹ä¸€æ£Ÿæˆ¿å­', sig: 'build_house(row=None, col=None, floors=1, name="")', snippet: 'build_house(name="æˆ‘çš„å®¶")\n', params: [['row', 'ç¶²æ ¼åˆ— 0-39ï¼ŒNone è‡ªå‹•'], ['col', 'ç¶²æ ¼æ¬„ 0-39'], ['floors', 'æ¨“å±¤æ•¸'], ['name', 'æ¨™ç±¤']] },
            { name: 'build_apartment', emoji: 'ğŸ¢', desc: 'è“‹å…¬å¯“å¤§æ¨“', sig: 'build_apartment(row=None, col=None, floors=4, name="")', snippet: 'build_apartment(floors=6, name="Aæ£Ÿ")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['floors', 'æ¨“å±¤2-10'], ['name', 'æ¨™ç±¤']] },
            { name: 'build_park', emoji: 'ğŸŒ³', desc: 'å»ºé€ å…¬åœ’', sig: 'build_park(row=None, col=None, name="")', snippet: 'build_park(name="ä¸­å¤®å…¬åœ’")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_pool', emoji: 'ğŸŠ', desc: 'å»ºé€ æ¸¸æ³³æ± ', sig: 'build_pool(row=None, col=None, name="")', snippet: 'build_pool(name="æ¸¸æ³³æ± ")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_library', emoji: 'ğŸ“–', desc: 'å»ºé€ åœ–æ›¸é¤¨', sig: 'build_library(row=None, col=None, name="")', snippet: 'build_library(name="åœ–æ›¸é¤¨")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_school', emoji: 'ğŸ«', desc: 'å»ºé€ å­¸æ ¡', sig: 'build_school(row=None, col=None, name="")', snippet: 'build_school(name="æœªä¾†ä¸­å­¸")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_hospital', emoji: 'ğŸ¥', desc: 'å»ºé€ é†«é™¢', sig: 'build_hospital(row=None, col=None, name="")', snippet: 'build_hospital(name="å¸‚ç«‹é†«é™¢")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_shop', emoji: 'ğŸª', desc: 'å»ºé€ å•†åº—', sig: 'build_shop(row=None, col=None, name="")', snippet: 'build_shop(name="ä¾¿åˆ©å•†åº—")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_fountain', emoji: 'â›²', desc: 'å»ºé€ å™´æ°´æ± ', sig: 'build_fountain(row=None, col=None, name="")', snippet: 'build_fountain(name="å™´æ°´æ± ")\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['name', 'åç¨±']] },
            { name: 'build_road', emoji: 'ğŸ›£ï¸', desc: 'é‹ªè¨­é“è·¯', sig: 'build_road(row=20, col=20, direction="h")', snippet: 'build_road(row=20, col=20)\n', params: [['row', 'åˆ—'], ['col', 'æ¬„'], ['direction', '"h"æ°´å¹³/"v"å‚ç›´']] },
            { name: 'build_power_tower', emoji: 'âš¡', desc: 'å»ºé€ é›»åŠ›å¡”', sig: 'build_power_tower(row=None, col=None)', snippet: 'build_power_tower()\n', params: [['row', 'åˆ—'], ['col', 'æ¬„']] },
            { name: 'clear_all', emoji: 'ğŸ—‘ï¸', desc: 'æ¸…é™¤æ‰€æœ‰å»ºç¯‰', sig: 'clear_all()', snippet: 'clear_all()\n', params: [] },
        ];

        let editor;

        function setupEditor() {
            const wrap = document.getElementById('editorWrap');
            const ta = document.createElement('textarea');
            ta.value = STARTER_CODE;
            wrap.appendChild(ta);
            editor = CodeMirror.fromTextArea(ta, {
                mode: 'python',
                theme: 'dracula',
                lineNumbers: true,
                indentUnit: 4,
                tabSize: 4,
                indentWithTabs: false,
                lineWrapping: false,
                autofocus: true,
                extraKeys: { 'Ctrl-Enter': runCode, 'Cmd-Enter': runCode },
            });
            editor.setSize('100%', '100%');
        }

        function buildLibCards() {
            const body = document.getElementById('libBody');
            const tooltip = document.getElementById('fnTooltip');

            LIB_FUNCTIONS.forEach(fn => {
                const card = document.createElement('div');
                card.className = 'lib-fn-card';
                card.innerHTML = `<span class="fn-emoji">${fn.emoji}</span><span class="fn-name">${fn.name}</span>`;

                card.addEventListener('click', () => {
                    if (editor) { editor.replaceRange(fn.snippet, editor.getCursor()); editor.focus(); }
                    tooltip.style.display = 'none';
                });
                card.addEventListener('mouseenter', () => {
                    const paramHtml = fn.params.map(([p, d]) =>
                        `<div class="tt-param"><span>${p}</span> â€” ${d}</div>`).join('');
                    tooltip.innerHTML = `<div class="tt-name">${fn.emoji} ${fn.name}</div><div class="tt-sig">${fn.sig}</div><div class="tt-desc">${fn.desc}</div>${paramHtml}<div class="tt-hint">â–¸ é»æ“Šæ’å…¥ç¨‹å¼ç¢¼</div>`;
                    const rect = card.getBoundingClientRect();
                    tooltip.style.left = Math.min(rect.right + 10, window.innerWidth - 285) + 'px';
                    tooltip.style.top = Math.min(rect.top, window.innerHeight - 215) + 'px';
                    tooltip.style.display = 'block';
                });
                card.addEventListener('mouseleave', () => { tooltip.style.display = 'none'; });
                body.appendChild(card);
            });
        }

        function log(msg, cls = 'log-info') {
            const body = document.getElementById('outputBody');
            const div = document.createElement('div');
            div.className = cls;
            div.textContent = msg;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        }
        function clearLog() { document.getElementById('outputBody').innerHTML = ''; }

        function setStatus(text, cls) {
            const el = document.getElementById('footerStatus');
            el.textContent = text;
            el.className = cls;
        }

        function runCode() {
            if (!window.PythonRunner || !window.CityLib) { log('âš  å¼•æ“å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦', 'log-warn'); return; }
            const code = editor ? editor.getValue() : '';
            clearLog();
            document.getElementById('btnRun').classList.add('running');
            setStatus('â— åŸ·è¡Œä¸­â€¦', 'running');
            log('â–¸ é–‹å§‹åŸ·è¡Œ Python ç¨‹å¼ç¢¼â€¦', 'log-info');

            setTimeout(() => {
                try {
                    const { jsCode, parseErrors, execResults, totalBuilt } = window.PythonRunner.run(code);
                    document.getElementById('jsCode').textContent = jsCode;
                    parseErrors.forEach(e => log(`âš  ç¬¬ ${e.line} è¡Œï¼š${e.msg}`, 'log-warn'));
                    execResults.forEach(r => {
                        if (r.ok) log(`âœ“ ç¬¬ ${r.call.lineNum} è¡Œï¼š${r.call.fn}() â†’ ${r.result ? r.result.type : 'å®Œæˆ'}`, 'log-ok');
                        else log(`âœ— ç¬¬ ${r.call.lineNum} è¡Œï¼š${r.call.fn}() â€” ${r.error}`, 'log-err');
                    });
                    const errCount = execResults.filter(r => !r.ok).length;
                    log(`â–¸ å®Œæˆï¼å…±å»ºé€  ${totalBuilt} å€‹è¨­æ–½${errCount > 0 ? `ï¼Œ${errCount} å€‹éŒ¯èª¤` : ''}`,
                        totalBuilt > 0 ? 'log-ok' : 'log-warn');

                    const badge = document.getElementById('outputBadge');
                    badge.textContent = totalBuilt > 0 ? `âœ“ ${totalBuilt} å€‹å»ºé€ ` : '0 å€‹å»ºé€ ';
                    badge.className = 'badge ' + (totalBuilt > 0 ? 'badge-ok' : 'badge-err');
                    setStatus(totalBuilt > 0 ? `â— ${totalBuilt} å€‹æˆåŠŸ` : 'â— ç„¡å»ºé€ ', totalBuilt > 0 ? 'ready' : 'error');
                } catch (err) {
                    log(`âœ— åŸ·è¡ŒéŒ¯èª¤ï¼š${err.message}`, 'log-err');
                    setStatus('â— åŸ·è¡ŒéŒ¯èª¤', 'error');
                }
                document.getElementById('btnRun').classList.remove('running');
                const panel = document.getElementById('outputPanel');
                panel.classList.remove('collapsed');
                panel.classList.add('expanded');
            }, 50);
        }

        function clearMap() {
            if (!window.CityLib) return;
            window.CityLib.clear_all();
            clearLog();
            log('â–¸ åœ°åœ–å·²æ¸…é™¤ã€‚', 'log-info');
            document.getElementById('outputBadge').textContent = 'å°±ç·’';
            document.getElementById('outputBadge').className = 'badge badge-info';
            setStatus('â— å°±ç·’', 'ready');
        }

        document.getElementById('btnRun').addEventListener('click', runCode);
        document.getElementById('btnClear').addEventListener('click', clearMap);
        document.getElementById('btnJsToggle').addEventListener('click', () => {
            document.getElementById('jsPreview').classList.toggle('visible');
        });
        document.getElementById('outputHeader').addEventListener('click', () => {
            const p = document.getElementById('outputPanel');
            p.classList.toggle('expanded');
            p.classList.toggle('collapsed');
        });
        let libOpen = true;
        document.getElementById('libHeader').addEventListener('click', () => {
            libOpen = !libOpen;
            document.getElementById('libBody').style.display = libOpen ? '' : 'none';
            document.getElementById('libToggleIcon').textContent = libOpen ? 'â–²' : 'â–¼';
        });
        document.addEventListener('keydown', e => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') { e.preventDefault(); runCode(); }
        });

        window.addEventListener('DOMContentLoaded', () => {
            setupEditor();
            buildLibCards();
        });
    </script>
</body>

</html>